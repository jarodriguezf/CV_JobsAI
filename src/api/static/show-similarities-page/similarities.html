<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title>Panel de Control</title>
    <link rel="icon" type="image/x-icon" href="/static/assets/favicon.ico" />
    <!-- Bootstrap CSS -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <!-- Core theme CSS (includes Bootstrap)-->
    <link href="/static/css/styles.css" rel="stylesheet" />
</head>
<body id="page-top">
    <!-- Navigation-->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top" id="mainNav">
        <div class="container px-4">
            <a class="navbar-brand" href="/">CV & Jobs AI - Match</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarResponsive">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/insert-data">Insertar datos</a></li>
                    <li class="nav-item"><a class="nav-link" href="/show-similarities">Cribar CV</a></li>
                </ul>
            </div>
        </div>
    </nav>
    <!-- Seccion para los botones de mostrar cv o oferta -->
    <section class="py-5" style="width: 100%; text-align: center; margin-top: 40px; overflow: auto;">
        <div class="container">
            <!-- Botones para mostrar las listas -->
            <button class="btn btn-primary mb-3" style="margin-right: 40px;" onclick="prepararYMostrarArchivo('cv')">Mostrar CVs</button>
            <button class="btn btn-primary mb-3" style="margin-left: 40px;" onclick="prepararYMostrarArchivo('ofertas')">Mostrar Ofertas Laborales</button>
            <hr>
        </div>
        <div style="margin: 25px;">
            <h5>Extrae los CVs más similares por cada oferta laboral</h5>
        </div>
        <div>
            <div>
                <label for="quantity">Indica el ID de la oferta laboral:</label>
                <input type="number" id="quantity" name="quantity" min="0" style="width: 3em; margin-right: 40px;">
            </div>
            <div>
                <label for="threshold">Indica el grado de similitud a mostrar:</label>
                <select name="threshold" style="margin-left: 10px;">
                    <option value="0.4">Bajo</option>
                    <option value="0.6">Equilibrado</option>
                    <option value="0.8">Alto</option>
                </select>
                <button class="btn btn-primary btn-sm mb-2" onclick="mostrarSimilitud()">Calcular</button>
            </div>
        </div>
    </section>
</body>
<script>

    // Llamada a la api retornando objeto JSON con texto tanto de oferta laboral como CVs
    function getSimilarCVs(ofertaLaboralId, gradoSimilitud) {
        // Creamos tipo formData para almacenar valores y enviarlos a la api
        const formData = new FormData();
        formData.append('id', ofertaLaboralId);
        formData.append('similarity', gradoSimilitud);

        return fetch('/call_model_to_similarities', {
            method: 'POST',
            body: formData 
        }) 
        .then(response => response.json())
        .then(data => {
            console.log('Length of data:', data.length);
            if(data){
                console.log('Datos recibido correctamente')
            }
            return data; // retornamos el dato devuelto por la API
        })
        .catch(error => console.error('Error:', error));  
    }

    // Funcion para realizar el calculo de la similitud del coseno (mostramos en pantalla resultados)
    async function mostrarSimilitud(){

        // Eliminar resultados anteriores
        const oldResults = document.getElementById('resultsContainer');
        if (oldResults) oldResults.remove();

        // Obtener los valores de los inputs
        const ofertaLaboralId = parseInt(document.getElementById('quantity').value);
        const gradoSimilitud = parseFloat(document.querySelector('select[name="threshold"]').value);

        if (Number.isInteger(ofertaLaboralId) && ofertaLaboralId >= 0){ 
            // llamada a funcion que retorna los cv mas similares
            const similarCVs = await getSimilarCVs(ofertaLaboralId, gradoSimilitud);

            console.log(similarCVs)
            
            // Creamos contenedor para pintar resultados
            const resultsContainer = document.createElement('div');
            resultsContainer.id = 'resultsContainer';
            resultsContainer.style.width = '50%'; 
            resultsContainer.style.margin = '0 auto'; 

            // Añadir header y titulo principal en funcion de la oferta dada
            const jobOfferHeader = document.createElement('h2');
            jobOfferHeader.id = 'jobOfferHeader';
            jobOfferHeader.style.marginLeft = '15%';
            jobOfferHeader.style.marginBottom = '20px';
            jobOfferHeader.textContent = 'CVs mas aptos para la oferta laboral con ID: ' + ofertaLaboralId;
            resultsContainer.appendChild(jobOfferHeader);
            
            // Añadir header y titulo principal en funcion de la oferta dada
            const separator = document.createElement('hr');
            resultsContainer.appendChild(separator);

            // Añadir a listas los CVs 
            const cvList = document.createElement('ul');
            cvList.id = 'cvList';
            let count = 0;
            let page = 1;
            for (const cv of similarCVs) {
                const cvListItem = document.createElement('li');
                cvListItem.innerHTML = `ID: ${cv.id}<br>CV: ${cv.cv}`;
                cvListItem.style.border= '1px solid #ccc';
                cvListItem.style.borderRadius = '5px';
                cvListItem.style.marginBottom = '10px';
                cvListItem.style.padding  = '10px';
                cvListItem.className = `page-${page}`;
                cvListItem.style.display = page === 1 ? 'block' : 'none';
                cvList.appendChild(cvListItem);
                count++;
                if (count % 5 === 0 && count < similarCVs.length) {
                    page++;
                }
            }
            resultsContainer.appendChild(cvList);

            // Añadir botones de paginacion al documento
            const paginationContainer = document.createElement('div');
            paginationContainer.id = 'paginationContainer';
            paginationContainer.style.textAlign = 'right';
            for (let i = 1; i <= page; i++) {
                const paginationButton = document.createElement('button');
                paginationButton.textContent = i;
                paginationButton.className = 'btn btn-primary btn-sm mb-2';
                paginationButton.style.margin = '0 5px';
                paginationButton.onclick = function() {
                    const items = document.querySelectorAll('#cvList li');
                    items.forEach(item => {
                        item.style.display = item.className === `page-${i}` ? 'block' : 'none';
                    });
                };
                paginationContainer.appendChild(paginationButton);
            }
            resultsContainer.appendChild(paginationContainer);

            // Añadir el resultado pintado al contenedor inicial
            document.body.appendChild(resultsContainer);

        }else{
            alert('Error. Solo es posible introducir numeros enteros mayor que 0. Asegurate que sean enteros. Ej:(0-10)')
        }
    }
    
    // Función para preparar y mostrar la informacion acerca de los CV o ofertas
    function prepararYMostrarArchivo(tipo) {
    // Hacer una petición GET a la API
        if (tipo==='cv'){
            fetch('/get-cvs')
                .then(response => response.text())
                .then(text => {
                    // Eliminamos expresiones '\n'
                    const trimmedtext = text.replace(/(?:\\r\\n|\\r|\\n)/g, '');
                    // Abre una nueva pestaña
                    const newTab = window.open();

                    // Escribimos el html
                    newTab.document.write(trimmedtext);

                    newTab.document.close();
                })
                .catch(error => console.error('Error:', error));
        }else if (tipo==='ofertas'){
            fetch('/get-jobs')
                .then(response => response.text())
                .then(text => {
                    // Eliminamos expresiones '\n'
                    const trimmedtext = text.replace(/(?:\\r\\n|\\r|\\n)/g, '');
                    // Abre una nueva pestaña
                    const newTab = window.open();

                    // Escribimos el html
                    newTab.document.write(trimmedtext);

                    newTab.document.close();
                })
                .catch(error => console.error('Error:', error));
        }    
    }  

</script>
 <!-- Añadir jQuery para Bootstrap -->
 <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
 <!-- Añadir JavaScript de Bootstrap -->
 <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</html>
